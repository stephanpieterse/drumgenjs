<!DOCTYPE html>
<html lang="en">
<head>
 <title>Accents Companion App</title>
 <link rel="manifest" href="/static/manifest.json">
 <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width, height=device-height" />
 <meta name="theme-color" content="#ffffff" />
 <meta name="description" content="A little app to generate patterns for you" />
 <meta name="msapplication-config" content="/static/browserconfig.xml"/>
	<meta name="replaceme">


<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
<meta name="msapplication-TileColor" content="#da532c">

<link rel="stylesheet" href="https://drumgen.apollolms.co.za/static/page.css" type="text/css" />
<link rel="shortcut icon" type="image/x-icon" href="/static/favicon.ico">
</head>
<body>
<div class="emptyimg" style="width:0px; height:0px"></div>
<div class="wide75" style="width: 250px; height: 52px;"> 
  <a class="settings-image" href="#" ><img class="util-image" src="https://drumgen.apollolms.co.za/static/settings.png" alt="settings" /></a>
</div>
<main>
<div class="centerme wide75">

<section>
<div class="settingspanel abs-panel" style="display:none">
    Barlength:
		<input name="barlength" type="number" value="4"/><br/>
    
    <div class="tuples_enabled">
    Tuples:<br/>
		<label><input name="etuple2" type="checkbox" value="2" checked="checked" />2 - Eights<br/></label>
		<label><input name="etuple3" type="checkbox" value="3" checked="checked" />3 - Triplets<br/></label>
		<label><input name="etuple4" type="checkbox" value="4" checked="checked" />4 - Sixteenths<br/></label>
		<label><input name="etuple5" type="checkbox" value="5" />5 - Quintuplets<br/></label>
		<label><input name="etuple6" type="checkbox" value="6" />6 - Sextuplets<br/></label>
		<label><input name="etuple7" type="checkbox" value="7" />7 - Septuplets<br/></label>
		<label><input name="etuple9" type="checkbox" value="9" />9 - Nontuplets<br/></label>
    </div>

    <div class="extra_settings">
		  <label>Tempo:<input name="tempo" type="number" value="100"/><br/></label>
		  <label><input name="metronome_on" type="checkbox" value="1" />Metronome in audio<br/></label>
		  <!-- <label><input name="nested_tuples" type="checkbox" value="1" />Nested tuples<br/></label> -->
		  <label><input name="loop_audio" type="checkbox" value="loop_audio" />Loop Audio<br/></label>
    </div>

    <br/>
	<br/>	
	by Stephan Pieterse<br/>
	drumgen@apollolms.co.za

  <br/>
  <a target="_system" href="https://drumgen.apollolms.co.za/static/donate.html">Donate</a>

	</div>

<div class="mainholder" style="text-align:center;">
  <img class="loader-image" src="https://drumgen.apollolms.co.za/static/loader.gif" alt="loader"></div>
  <img class="pattern-image" src="" alt="pattern image"/>
  <div class="mainsndholder">
    <audio class="audiosrc" src='' type="audio/ogg" preload="auto" controls> </audio>
  </div>
<br/>
</section>
</div>
</main>
<noscript>
	Unfortunately, this site requires javascript to run properly at this time!
</noscript>

<script type="text/javascript" src="/static/jquery.js"></script>
<script type="text/javascript" src="/static/hammer.min.js"></script>

<script type="text/javascript">
  if ('serviceWorker' in navigator) {
    // register service worker
    navigator.serviceWorker.register('/static/serviceworker.js');
  }

  var healthCheck = setInterval(function(){
    $.get("https://drumgen.apollolms.co.za/health").done(function(){
      $('.healthpanel').hide();
    }).catch(function(){ 
      $('.healthpanel').show();
    });
  }, 1000 * 30);

  // button clicks
  $('.about-image').click(function() {
      $('.aboutpanel').toggle();
      $('.settingspanel').hide();
  });
  $('.settings-image').click(function() {
      $('.settingspanel').toggle();
      $('.aboutpanel').hide();
  });

  var funcs = {};
	var settings = {};

  var seedcount = 0;
  var cseed = "public";
  
  funcs.getSeed = function(){
    // new postfix every 4s
    var inst = parseInt(new Date().getTime() / 1000 / 4);
    seedcount = (seedcount + 1) % 5;
    cseed = "x-dg-app-" + inst + seedcount;
  }

  funcs.getSeed();

  var audiobaseurl = 'https://drumgen.apollolms.co.za/public/audio?app=true'; //asbase64=false';
  var audiorefreshurl = 'https://drumgen.apollolms.co.za/public/refresh/audio?app=true'; //asbase64=false';
  var imagebaseurl = 'https://drumgen.apollolms.co.za/public/image?app=true'; //asbase64=false';

	settings.pattern_length = 4;
	settings.pattern_type = 'accent';
  settings.pattern_limbs = 4;
  settings.pattern_tuples = [2,3,4];
	//settings.cache_name = "dg-images";
	settings.cache_prefix = "dg";
  settings.metronome_on = false;
  settings.nested_tuples = false;
  settings.loop_audio = false;
  settings.tempo = 100;

 // funcs.getCurCache = function(){
 //   return settings.cache_name + settings.pattern_type + settings.pattern_length + settings.pattern_limbs;
 // }

  var LS = {
      get: function(a) {
          return JSON.parse(window.localStorage.getItem(a));
      },
      set: function(a, b) {
          window.localStorage.setItem(a, JSON.stringify(b));
      },
      clearCache: function() {
          for (var i = 0; i < window.localStorage.length; i++) {
              if (window.localStorage.key(i).indexOf(settings.cache_prefix) === 0) {
                  LS.set(window.localStorage.key(i), []);
              }
          ;}
      }

  };

var getId = function() {
    var idheader = 'x-drumgen-id';
    var cid = LS.get(idheader);
    if (cid) {
        return cid;
    }
    var ncid = '_' + Math.random().toString(36).substr(2, 9);
    LS.set(idheader, ncid);
    return ncid;
};

var ID = getId();

$.ajaxSetup({
    headers: {
        "x-drumgen-id": ID
    }
});

//function preloadImages(ti) {
//      var totalImages = ti || 5;
//      var maxImages = 50;
//      var curCache = funcs.getCurCache();
//      var imgArr = LS.get(curCache) || [];
//
//      if (imgArr.length >= maxImages) {
//          return false;
//      }
//
//      for (var i = 0; i < totalImages; i++) {
//          funcs.getSeed();
//					funcs.loadImage[settings.pattern_type]($('.emptyimg'), function(newimg, newsnd){
//              
//                  var proms = [];
//                  var imgprom = $.get(newimg + '&asbase64=true');
//                  var sndprom = $.get(newsnd + '&asbase64=true'); 
//                  proms.push(sndprom);
//                  proms.push(imgprom);
//
//                  var allprom = Promise.all(proms);
//
//                  console.log({msg:"preloading", snd: newsnd, img: newimg});
//                  allprom.then(function(values) {
//                      console.log({msg: "preloading done"});
//                      var imgArr = LS.get(curCache) || [];
//                      nobj = {};
//                      nobj.sound = values[0];
//                      nobj.image = values[1];
//                      imgArr.push(nobj);
//                      LS.set(curCache, imgArr);
//                  }).catch(function(error){
//								  		console.error(error);
//                  });
//          });
//      }
//  }
//

  function setSound(sndhref, element){
    element.remove();
    var sndsrc = '<audio class="audiosrc" src="{SRCVAL}" {LOOP} type="audio/ogg"  preload="auto" controls> Your browser does not support the audio element tag. </audio>';
    sndsrc = sndsrc.replace('{SRCVAL}', sndhref);
    if(settings.loop_audio){
      sndsrc = sndsrc.replace('{LOOP}', "loop");
    } else {
      sndsrc = sndsrc.replace('{LOOP}', "");
    }
    $('.mainsndholder').append(sndsrc);
  }

  function setImage(imghref, element) {

      loader.show();
      element.hide();
      element.on("load", function() {
          loader.hide();
          element.show();
      });
      element.attr("src", imghref);

  }

 // funcs.getRandom = function(){
 //     var min = 1;
 //     var max = Math.pow(5, settings.pattern_length);
 //     var randNum = parseInt((Math.random() * (max - min)) + min);
 //     return randNum;
 // };

	funcs.loadImage = {};

//	funcs.loadImage['accent'] = function(element, cb){
//      var randNum = funcs.getRandom();
//
//      loader.show();
//      element.hide();
//
//      $.get('https://drumgen.apollolms.co.za/convertnum?num=' + randNum + '').done(function(data) {
//          funcs.getSeed();
//          var newimg = imagebaseurl + '&seed=' + cseed + '&patlen=' + settings.pattern_length + '&tuples=' + settings.pattern_tuples;
//          var newsnd = audiobaseurl + '&seed=' + cseed + '&patlen=' + settings.pattern_length + '&tuples=' + settings.pattern_tuples + '&nometro=' + !settings.metronome_on;
//
//          element.on("load", function() {
//              loader.hide();
//              element.show();
//          });
//
//          element.attr("src", newimg);
//
//          if(cb){
//						cb(newimg, newsnd);
//					}
//      })
//	}

 // function loadNewImage(element) {
 // 	funcs.loadImage[settings.pattern_type](element, function(){
 //     console.log(arguments);
 //   });
 // }

  var loader = $('.loader-image');
  var imgholder = $('.pattern-image');
  var sndholder = $('.audiosrc');
  var mainsndholder = $('.mainsndholder');
 
  loader.hide();
//  var loadNextImage = function(element) {
//  
//      var curCache = funcs.getCurCache();
//      var nextImages = LS.get(curCache);
//
//      if (nextImages && nextImages.length) {
//				console.log("getting image from cache");
//          var patObj = nextImages.shift();
//          var nextImage = patObj.image;
//          var nextSound = patObj.sound;
//          LS.set(curCache, nextImages);
//          if (nextImage) {
//              setImage(nextImage, element);
//              setSound(nextSound, sndholder);
//              funcs.preloadImages(1);
//          } else {
//              loadNewImage(element);
//              funcs.preloadImages(1);
//          }
//      } else {
//          loadNewImage(element);
//          funcs.preloadImages(1);
//      }
//  }
//

  var init = function(){
          //LS.clearCache();
          funcs.getSeed();
          loader.show();
          imgholder.hide();
          mainsndholder.hide();
          var newimg = imagebaseurl + '&seed=' + cseed + '&patlen=' + settings.pattern_length + '&tuples=' + settings.pattern_tuples + '&nested=' + settings.nested_tuples + '&nometro=' + !settings.metronome_on + '&tempo=' + settings.tempo;
          var newsnd = audiobaseurl + '&seed=' + cseed + '&patlen=' + settings.pattern_length + '&tuples=' + settings.pattern_tuples + '&nested=' + settings.nested_tuples + '&nometro=' + !settings.metronome_on + '&tempo=' + settings.tempo;

          imgholder.on("load", function() {
              loader.hide();
              imgholder.show();
              mainsndholder.show();
          });

          imgholder.attr("src", newimg);
          sndholder.attr("src", newsnd);

}
  
  var hammerOptions = {};
  var hammertime = new Hammer(imgholder[0], hammerOptions);
  var hammerloadertime = new Hammer(loader[0], hammerOptions);

  hammertime.on('swipe', function(ev) {
      // loadNextImage(imgholder);
      //init();
      callToChange();
  });

  hammerloadertime.on('swipe', function(ev) {
      //init();
      callToChange();
  });
  // STARTUP CODE SECTION

  init();

</script>


	<div class="healthpanel" style="display:none">
		 We are having some trouble accessing the server, please wait a few minutes or try again later.
	</div>

<script type="text/javascript">

  function callToChange(){
    init();
  }

  function callToRefresh(){
  
          funcs.getSeed();
          loader.show();
          //imgholder.hide();
          mainsndholder.hide();
          //var newimg = imagebaseurl + '&seed=' + cseed + '&patlen=' + settings.pattern_length + '&tuples=' + settings.pattern_tuples;
          var newsnd = audiorefreshurl + '&seed=' + cseed + '&patlen=' + settings.pattern_length + '&tuples=' + settings.pattern_tuples + '&nometro=' + !settings.metronome_on + '&tempo=' + settings.tempo;

          //imgholder.attr("src", newimg);
          sndholder.attr("src", newsnd);
          sndholder.on("canplay", function(){
            mainsndholder.show();
            loader.hide();
          });

  }

	var bl = $('[name="barlength"]');
  bl.change(function(){
		blval = bl.val() <= 0 ? 1 : bl.val() % 16;
		bl.val(blval);
		settings.pattern_length = blval;

    callToChange();    

  });

	var temposel = $('[name="tempo"]');
  temposel.change(function(){
		temposelval = temposel.val() <= 0 ? 34 : temposel.val() % 320;
		temposel.val(temposelval);
		settings.tempo = temposelval;

    callToRefresh();    

  });

	var gl = $('[name="groovelimbs"]');
  gl.change(function(){
		glval = gl.val() <= 0 ? 1 : gl.val() % 4;
		gl.val(glval);
		settings.pattern_limbs = glval;
    callToChange();    
  });

	$('[name="pattype"]').click(function() {
	    var type = $('[name="pattype"]:checked').val().toLowerCase();
	    settings.pattern_type = type;
	    console.log("pattype is " + type);
	});

	$('[name^="etuple"]').click(function() {
	    settings.pattern_tuples = [];
	    $('[name^="etuple"]:checked').each(function() {
	        settings.pattern_tuples.push($(this).val());
	    });
	    console.log("tuple set is " + settings.pattern_tuples);
      callToChange();    
	});

  $('[name="metronome_on"]').click(function(){
	    settings.metronome_on = ($('[name="metronome_on"]:checked').val()) ? true : false;
      callToRefresh();
  });

  $('[name="nested_tuples"]').click(function(){
	    settings.nested_tuples = ($('[name="nested_tuples"]:checked').val()) ? true : false;
      callToChange();
  });

  $('[name="loop_audio"]').click(function(){
	    settings.loop_audio = ($('[name="loop_audio"]:checked').val()) ? true : false;
      var sndholder = $('.audiosrc');
      if(settings.loop_audio){
        sndholder.attr("loop", "true");
      } else {
        sndholder.removeAttr("loop");
      }
      //callToRefresh();
  });

</script>
<div class="beforeend"></div>
</body>
</html>
