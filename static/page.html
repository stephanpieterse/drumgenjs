<!DOCTYPE html>
<html lang="en">
<head>
 <title>Accents Companion App</title>
 <link rel="manifest" href="/static/manifest.json">
 <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width, height=device-height" />
 <meta name="theme-color" content="#ffffff" />
 <meta name="description" content="A little app to generate patterns for you" />
 <meta name="msapplication-config" content="/static/browserconfig.xml"/>
<link rel="apple-touch-icon" sizes="180x180" href="/static/apple-touch-icon.png">
<link rel="mask-icon" href="/static/safari-pinned-tab.svg" color="#5bbad5">
<meta name="msapplication-TileColor" content="#da532c">

<link rel="stylesheet" href="/static/page.css" type="text/css" />
<link rel="shortcut icon" type="image/x-icon" href="/static/favicon.ico">
</head>
<body>
<div class="emptyimg" style="width:0px; height:0px"></div>
<div class="wide75" style="width: 250px; height: 52px;"> 
  <a class="settings-image" href="#" ><img class="util-image" src="/static/settings.png" alt="settings" /></a>
  <a class="reload-image" href="#" ><img class="util-image" src="/static/reload.png" alt="reload" /></a>
</div>
<main>
<div class="centerme wide75">

<section>
<div class="settingspanel abs-panel" style="display:none">
    <a class="settings-image" href="#" ><img class="small-util-image" src="/static/settings.png" alt="settings" /></a>
    Barlength:
    <input type="button" value="-" class="minusbtn" field="barlength" />
		<input name="barlength" type="number" value="4"/>
    <input type="button" value="+" class="plusbtn" field="barlength" />
		<br/>
    
    <div class="tuples_enabled">
    Tuples:<br/>
		<label><input name="etuple2" type="checkbox" value="2" checked="checked" />2 - Eights</label>
		<label><input name="etuple3" type="checkbox" value="3" checked="checked" />3 - Triplets</label>
    <br/>
		<label><input name="etuple4" type="checkbox" value="4" checked="checked" />4 - Sixteenths</label>
		<label><input name="etuple5" type="checkbox" value="5" />5 - Quintuplets</label>
    <br/>
		<label><input name="etuple6" type="checkbox" value="6" />6 - Sextuplets</label>
		<label><input name="etuple7" type="checkbox" value="7" />7 - Septuplets</label>
    <br/>
		<label><input name="etuple9" type="checkbox" value="9" />9 - Nontuplets</label>
    </div>

    <div class="extra_settings">
      <input type="button" value="-" class="minusbtn" field="tempo" />
		  <label>Tempo:<input name="tempo" type="number" value="100"/></label>
      <input type="button" value="+" class="plusbtn" field="tempo" />
			<br/>
		  <label><input name="metronome_on" type="checkbox" value="1" />Metronome in audio<br/></label>
		  <label><input name="rests_on" type="checkbox" value="1" checked="checked" />Rests in pattern<br/></label>
		  <!-- <label><input name="nested_tuples" type="checkbox" value="1" />Nested tuples<br/></label> -->
		  <label><input name="loop_audio" type="checkbox" value="loop_audio" />Loop Audio<br/></label>
    </div>

    <br/>
	<br/>	
	by Stephan Pieterse<br/>
	drumgen@apollolms.co.za
  <br/>
  <!-- <a target="_system" href="/static/donate.html">Donate</a> -->
	</div>

<div class="mainholder" style="text-align:center;">
  <img class="loader-image" src="/static/loader.gif" alt="loader"></div>
  <img class="pattern-image" src="" alt="pattern image"/>
  <div class="mainsndholder">
    <audio class="audiosrc" src='' type="audio/ogg" preload="auto" controls> </audio>
  </div>
<br/>
</section>
</div>
</main>
<noscript>
	Unfortunately, this site requires javascript to run properly at this time!
</noscript>

<script type="text/javascript" src="/static/jquery.js"></script>
<script type="text/javascript" src="/static/hammer.min.js"></script>

<script type="text/javascript">
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/static/serviceworker.js');
  }

  var healthCheck = setInterval(function(){
    $.get("/health").done(function(){
      $('.healthpanel').hide();
    }).catch(function(){ 
      $('.healthpanel').show();
    });
  }, 1000 * 30);

  $('.settings-image').click(function() {
      $('.settingspanel').toggle();
  });

  $('.reload-image').click(function() {
    callToChange();
  });

  var funcs = {};
	var settings = {};

  var seedcount = 0;
  var cseed = "public";
  
  funcs.getSeed = function(){
    // new postfix every 3s
    var inst = parseInt(new Date().getTime() / 1000 / 3);
    seedcount = (seedcount + 1) % 5;
    cseed = "x-dg-app-" + inst + seedcount;
  }

  funcs.getSeed();

  var hosturl = '';
  var audiobaseurl = hosturl + '/public/audio?app=true'; //asbase64=false';
  var hburlext = '&seed={{SEED}}&patlen={{PATLEN}}&tuples={{TUPLES}}&nested={{NESTED}}&nometro={{NOMETRO}}&tempo={{TEMPO}}&norests={{NORESTS}}';
  var audiorefreshurl = hosturl + '/public/refresh/audio?app=true'; //asbase64=false';
  var imagebaseurl = hosturl + '/public/image?app=true'; //asbase64=false';

	settings.pattern_length = 4;
	settings.pattern_type = 'accent';
  settings.pattern_limbs = 4;
  settings.pattern_tuples = [2,3,4];
  settings.metronome_on = false;
  settings.rests_on = true;
  settings.nested_tuples = false;
  settings.loop_audio = false;
  settings.tempo = 100;

  var LS = {
      get: function(a) {
          return JSON.parse(window.localStorage.getItem(a));
      },
      set: function(a, b) {
          window.localStorage.setItem(a, JSON.stringify(b));
      }
  };

  var getId = function() {
      var idheader = 'x-drumgen-id';
      var cid = LS.get(idheader);
      if (cid) {
          return cid;
      }
      var ncid = '_' + Math.random().toString(36).substr(2, 9);
      LS.set(idheader, ncid);
      return ncid;
  };
  
  var ID = getId();
  
  $.ajaxSetup({
      headers: {
          "x-drumgen-id": ID
      }
  });

  function setImage(imghref, element) {

      loader.show();
      element.hide();
      element.on("load", function() {
          loader.hide();
          element.show();
      });
      element.attr("src", imghref);

  }

  var loader = $('.loader-image');
  var imgholder = $('.pattern-image');
  var sndholder = $('.audiosrc');
  var mainsndholder = $('.mainsndholder');
 
  loader.hide();

  function buildTemplateUrl(base){
    return base.replace("{{SEED}}", cseed)
               .replace("{{PATLEN}}", settings.pattern_length)
               .replace("{{TUPLES}}", settings.pattern_tuples)
               .replace("{{NESTED}}", settings.nested_tuples)
               .replace("{{NOMETRO}}", !settings.metronome_on)
               .replace("{{NORESTS}}", !settings.rests_on)
               .replace("{{TEMPO}}", settings.tempo);
  }

  var init = function(){
          funcs.getSeed();
          loader.show();
          imgholder.hide();
          mainsndholder.hide();
          //var newimg = imagebaseurl + '&seed=' + cseed + '&patlen=' + settings.pattern_length + '&tuples=' + settings.pattern_tuples + '&nested=' + settings.nested_tuples + '&nometro=' + !settings.metronome_on + '&tempo=' + settings.tempo;
          var newimg = buildTemplateUrl(imagebaseurl + hburlext);

          var newsnd = buildTemplateUrl(audiobaseurl + hburlext);
       //   var newsnd = audiobaseurl + '&seed=' + cseed + '&patlen=' + settings.pattern_length + '&tuples=' + settings.pattern_tuples + '&nested=' + settings.nested_tuples + '&nometro=' + !settings.metronome_on + '&tempo=' + settings.tempo;

          imgholder.on("load", function() {
              loader.hide();
              imgholder.show();
              mainsndholder.show();
          });

          imgholder.attr("src", newimg);
          sndholder.attr("src", newsnd);

  }
  
  var hammerOptions = {};
  var hammertime = new Hammer(imgholder[0], hammerOptions);
  var hammerloadertime = new Hammer(loader[0], hammerOptions);

  hammertime.on('swipe', function(ev) {
      callToChange();
  });

  hammerloadertime.on('swipe', function(ev) {
      callToChange();
  });

  init();

</script>

	<div class="healthpanel" style="display:none">
		 We are having some trouble accessing the server, please wait a few minutes or try again later.
	</div>

<script type="text/javascript">

  function callToChange(){
    init();
  }

  function callToRefresh(){
  
          funcs.getSeed();
          loader.show();
          mainsndholder.hide();
          //var newsnd = audiorefreshurl + '&seed=' + cseed + '&patlen=' + settings.pattern_length + '&tuples=' + settings.pattern_tuples + '&nometro=' + !settings.metronome_on + '&tempo=' + settings.tempo;
          var newsnd = buildTemplateUrl(audiobaseurl + hburlext);

          sndholder.attr("src", newsnd);
          sndholder.on("canplay", function(){
            mainsndholder.show();
            loader.hide();
          });

  }

	var bl = $('[name="barlength"]');
  bl.change(function(){
		blval = bl.val() <= 0 ? 1 : bl.val() % 16;
		bl.val(blval);
		settings.pattern_length = blval;

    callToChange();    

  });

	var temposel = $('[name="tempo"]');
  temposel.change(function(){
		temposelval = temposel.val() <= 0 ? 34 : temposel.val() % 320;
		temposel.val(temposelval);
		settings.tempo = temposelval;

    callToRefresh();    

  });

	var gl = $('[name="groovelimbs"]');
  gl.change(function(){
		glval = gl.val() <= 0 ? 1 : gl.val() % 4;
		gl.val(glval);
		settings.pattern_limbs = glval;
    callToChange();    
  });

	//$('[name="pattype"]').click(function() {
	//    var type = $('[name="pattype"]:checked').val().toLowerCase();
	//    settings.pattern_type = type;
	//    console.log("pattype is " + type);
	//});

	$('[name^="etuple"]').click(function() {
	    settings.pattern_tuples = [];
	    $('[name^="etuple"]:checked').each(function() {
	        settings.pattern_tuples.push($(this).val());
	    });
	    console.log("tuple set is " + settings.pattern_tuples);
      callToChange();    
	});

  $('[name="rests_on"]').click(function(){
	    settings.rests_on = ($('[name="rests_on"]:checked').val()) ? true : false;
      callToChange();
  });

  $('[name="metronome_on"]').click(function(){
	    settings.metronome_on = ($('[name="metronome_on"]:checked').val()) ? true : false;
      callToRefresh();
  });

  $('[name="nested_tuples"]').click(function(){
	    settings.nested_tuples = ($('[name="nested_tuples"]:checked').val()) ? true : false;
      callToChange();
  });

  $('[name="loop_audio"]').click(function(){
	    settings.loop_audio = ($('[name="loop_audio"]:checked').val()) ? true : false;
      var sndholder = $('.audiosrc');
      if(settings.loop_audio){
        sndholder.attr("loop", "true");
      } else {
        sndholder.removeAttr("loop");
      }
  });


  $('.plusbtn').click(function(ev){
    ev.preventDefault();
    var field = $(this).attr('field');
    var curval = parseInt($('input[name=' + field + ']').val());
    var newval = isNaN(curval) ? 0 : curval + 1;
    $('input[name=' + field + ']').val(newval);
    $('input[name=' + field + ']').change();
  });

  $('.minusbtn').click(function(ev){
    ev.preventDefault();
    var field = $(this).attr('field');
    var curval = parseInt($('input[name=' + field + ']').val());
    var newval = (isNaN(curval) || curval <= 0) ? 0 : curval - 1;
    $('input[name=' + field + ']').val(newval);
    $('input[name=' + field + ']').change();
  });
</script>
</body>
</html>
