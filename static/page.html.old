<html>
<head>
 <title>Accents Companion App</title>
	<meta name="replaceme">
<link rel="stylesheet" href="https://drumgen.apollolms.co.za/static/page.css" type="text/css" />
<link rel="shortcut icon" type="image/x-icon" href="/static/favicon.ico">
</head>
<body>
<div class="emptyimg" style="width:0px; height:0px"></div>
<div class="centerme wide75" style="width: 250px; height: 52px;"> 
  <!-- <a class="pattern-image-download" href="#" onclick="download();" ><img class="download-image" src="http://drumgen.apollolms.co.za/static/download.png" alt="download" /></a>  -->
  <a class="about-image" href="#" ><img class="util-image" src="https://drumgen.apollolms.co.za/static/about.png" alt="about" /></a>
  <a class="settings-image" href="#" ><img class="util-image" src="https://drumgen.apollolms.co.za/static/settings.png" alt="settings" /></a>
</div>
<div class="centerme wide75">
<div class="mainholder" style="text-align:center;">
  <img class="loader-image" src="https://drumgen.apollolms.co.za/static/loader.gif"></div>
  <img class="pattern-image" src="https://drumgen.apollolms.co.za/image?nometro=true&noname=true&map=sn&pat=sbbbbbbbbbb3e" />
  <!-- <audio controls><source class="audiosrc" src='http://drumgen.apollolms.co.za/audio?pat=sbbbbbbbbbb3e' type='audio/ogg'> </audio> -->
  <div class="mainsndholder">
    <audio class="audiosrc" src='https://drumgen.apollolms.co.za/audio?pat=sbbbbbbbbbb3e' type="audio/ogg" preload="auto"  controls> </audio>
  </div>
<br/>
</div>

<script type="text/javascript" src="/static/jquery.js"></script>
<script type="text/javascript" src="/static/hammer.min.js"></script>

<script type="text/javascript">
  var healthCheck = setInterval(function(){
    $.get("https://drumgen.apollolms.co.za/health").done(function(){
      $('.healthpanel').hide();
    }).catch(function(){ 
      $('.healthpanel').show();
    });
  }, 15000);

  // button clicks
  $('.about-image').click(function() {
      $('.aboutpanel').toggle();
  });
  $('.settings-image').click(function() {
      $('.settingspanel').toggle();
  });
</script>

<script type="text/javascript">

  var download = function() {
     
  }

  var funcs = {};
	var settings = {};

  var cseed = 0;
  funcs.getSeed = function(){
    var inst = parseInt(new Date().getTime() / 1000 / 5);
    cseed = (cseed + 1) % 4;
    return "app-" + cseed + inst;
  }

  var audiobaseurl = 'https://drumgen.apollolms.co.za/audio?nometro=true&noname=true&map=sn&asbase64=true&pat=';
  // var audiobaseurl = 'https://drumgen.apollolms.co.za/audio?nometro=true&noname=true&map=sn&pat=';

	settings.pattern_length = 8;
	settings.pattern_type = 'accent';
  settings.pattern_limbs = 4;
	settings.cache_name = "dg-images";
	settings.cache_prefix = "dg";

  funcs.getCurCache = function(){
    return settings.cache_name + settings.pattern_type + settings.pattern_length + settings.pattern_limbs;
  }

  var LS = {
      get: function(a) {
          return JSON.parse(window.localStorage.getItem(a));
      },
      set: function(a, b) {
          window.localStorage.setItem(a, JSON.stringify(b));
      },
      clearCache: function() {
          for (var i = 0; i < window.localStorage.length; i++) {
							console.log("key " + window.localStorage.key(i));
              if (window.localStorage.key(i).indexOf(settings.cache_prefix) === 0) {
									console.log("clearing key");
                  LS.set(window.localStorage.key(i), []);
              }
          }
      }

  };

  function preloadImages(ti) {
      var totalImages = ti || 5;
      var maxImages = 50;
      var curCache = funcs.getCurCache();
      var imgArr = LS.get(curCache) || [];

      if (imgArr.length >= maxImages) {
          return false;
      }

      for (var i = 0; i < totalImages; i++) {
					funcs.loadImage[settings.pattern_type]($('.emptyimg'), function(newimg, newsnd){
              
                  var proms = [];
                  var imgprom = $.get(newimg + "&asbase64=true");
                  var sndprom = $.get(newsnd); 
                  proms.push(sndprom);
                  proms.push(imgprom);

                  var allprom = Promise.all(proms);

                  allprom.then(function(values) {
                      var imgArr = LS.get(curCache) || [];
                      nobj = {};
                      nobj.sound = values[0];
                      nobj.image = values[1];
                      imgArr.push(nobj);
                      LS.set(curCache, imgArr);
                  }).catch(function(error){
								  		console.error(error);
                  });
          });
      }
  }

	funcs.preloadImages = preloadImages;

  function setSound(sndhref, element){
    // element.detach().attr("src", sndhref).appendTo('.mainsndholder');
    element.remove();
    var sndsrc = '<audio class="audiosrc" src="{SRCVAL}" type="audio/ogg"  preload="auto" controls> </audio>';
    sndsrc = sndsrc.replace('{SRCVAL}', sndhref);
    $('.mainsndholder').append(sndsrc);
  }

  function setImage(imghref, element) {

      loader.show();
      element.hide();
      //downloader.attr("href", imghref);
      element.attr("src", imghref);
      element.on("load", function() {
          loader.hide();
          element.show();
      });
  }


  funcs.getRandom = function(){
      var min = 1;
      var max = Math.pow(5, settings.pattern_length);
      var randNum = parseInt((Math.random() * (max - min)) + min);
      return randNum;
  };

	funcs.loadImage = {};
	funcs.loadImage['groove'] = function(element, cb){
      var randString = "";
      for (var j = 0; j < settings.pattern_limbs; j++ ){
        randString += funcs.getRandom();
        randString += ",";
      }
      randString = randString.slice(0, -1);
      loader.show();
      element.hide();
      $.get('https://drumgen.apollolms.co.za/convertmulti?nums=' + randString).done(function(data) {
          var newimg = "https://drumgen.apollolms.co.za/image?nometro=true&noname=true&pat=" + data + "&patlen=" + settings.pattern_length;
          var newsnd = audiobaseurl + data + "&patlen=" + settings.pattern_length;
        //  downloader.attr("href", newimg);

          element.attr("src", newimg);
          element.on("load", function() {
              loader.hide();
              element.show();
          });
          if(cb){
						cb(newimg, newsnd);
					}
       })
	}

	funcs.loadImage['accent'] = function(element, cb){
      var randNum = funcs.getRandom();
      loader.show();
      element.hide();
      $.get('https://drumgen.apollolms.co.za/convertnum?num=' + randNum + '&tuples=2,3').done(function(data) {
          var newimg = "https://drumgen.apollolms.co.za/image?nometro=true&noname=true&map=sn&pat=" + data + "&patlen=" + settings.pattern_length;
          var newsnd = audiobaseurl + data + "&patlen=" + settings.pattern_length;
        //  downloader.attr("href", newimg);
          element.attr("src", newimg);
          element.on("load", function() {
              loader.hide();
              element.show();
          });
          if(cb){
						cb(newimg, newsnd);
					}
      })
	}

  function loadNewImage(element) {
		funcs.loadImage[settings.pattern_type](element);
  }

  var loader = $('.loader-image');
  var imgholder = $('.pattern-image');
  var sndholder = $('.audiosrc');
 
  loader.hide();
  var loadNextImage = function(element) {
  
      var sndholder = $('.audiosrc');

      var curCache = funcs.getCurCache();
      var nextImages = LS.get(curCache);

      if (nextImages && nextImages.length) {
				console.log("getting image from cache");
          var patObj = nextImages.shift();
          var nextImage = patObj.image;
          var nextSound = patObj.sound;
          LS.set(curCache, nextImages);
          if (nextImage) {
              setImage(nextImage, element);
              setSound(nextSound, sndholder);
              funcs.preloadImages(2);
          } else {
              loadNewImage(element);
              funcs.preloadImages(2);
          }
      } else {
          loadNewImage(element);
          funcs.preloadImages(2);
      }
  }

  var hammerOptions = {};
  var hammertime = new Hammer(imgholder[0], hammerOptions);

  hammertime.on('swipe', function(ev) {
      // console.log(ev);
      loadNextImage(imgholder);
  });

  // STARTUP CODE SECTION

  LS.clearCache();
  loadNextImage(imgholder);

</script>

	<div class="settingspanel" style="display:none">
    Barlength:
		<input name="barlength" type="number" value="8"/><br/>
    

    <div class="tuples_enabled">
    Tuples:<br/>
		<input name="etuple2" type="checkbox" value="2" checked="checked" />2 - Eights<br/>
		<input name="etuple3" type="checkbox" value="3" checked="checked" />3 - Triplets<br/>
		<input name="etuple4" type="checkbox" value="4" checked="checked" />4 - Sixteenths<br/>
		<input name="etuple5" type="checkbox" value="5" checked="checked" />5 - Quintuplets<br/>
    </div>

    <!-- Groove limbs:
    <input name="groovelimbs" type="number" value="4"><br/>

		<input name="pattype" type="radio" value="accent" checked="checked" />Accent<br/>
		<input name="pattype" type="radio" value="groove"/>Groove<br/>
    -->
	</div>

	<div class="aboutpanel" style="display:none">
		
	by Stephan Pieterse<br/>
	drumgen@apollolms.co.za

  <br/>
  <a target="_blank" href="https://drumgen.apollolms.co.za/static/donate.html">Donate</a>

	</div>
	<div class="healthpanel" style="display:none">
		 We are having some trouble accessing the server, please wait a few minutes or try again later.
	</div>

<script type="text/javascript">

	var bl = $('[name="barlength"]');
  bl.change(function(){
		blval = bl.val() <= 0 ? 1 : bl.val() % 16;
		bl.val(blval);
		settings.pattern_length = blval;

		funcs.preloadImages(2);

  });

	var gl = $('[name="groovelimbs"]');
  gl.change(function(){
		glval = gl.val() <= 0 ? 1 : gl.val() % 4;
		gl.val(glval);
		settings.pattern_limbs = glval;
		funcs.preloadImages(2);
  });

	$('[name="pattype"]').click(function(){

		var type = $('[name="pattype"]:checked').val().toLowerCase();
		settings.pattern_type = type;


		console.log("pattype is " + type);
	});

</script>
<div class="beforeend"></div>
</body>
</html>
